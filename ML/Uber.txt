#Import all libraries

import pandas as pd 
import numpy as np
import seaborn as sns
import matplotlib.pyplot as plt
from haversine import haversine,Unit
from sklearn.model_selection import train_test_split
from sklearn.linear_model import LinearRegression
from sklearn.ensemble import RandomForestRegressor

#import dataset
df = pd.read_csv('uber.csv')

df.shape
df.columns
df.head()

#Preprocessing
df = df.dropna(subset = ['pickup_longitude', 'pickup_latitude', 'dropoff_longitude',
       'dropoff_latitude','fare_amount'])

df = df[df['fare_amount'] > 0 ]

if 'pickup_datetime' in df.columns:
    df['pickup_datetime'] = pd.to_datetime(df['pickup_datetime'] , errors = 'coerce')

df = df[(df['pickup_latitude'].between(-90, 90)) &
        (df['dropoff_latitude'].between(-90, 90)) &
        (df['pickup_longitude'].between(-180, 180)) &
        (df['dropoff_longitude'].between(-180, 180)) ]

df.shape


#Feature Engineering
def distance(row):
    a = (row['pickup_latitude'], row['pickup_longitude'])
    b = (row['dropoff_latitude'], row['dropoff_longitude'])
    return haversine(a, b, unit=Unit.KILOMETERS)

df['distance_km'] = df.apply(distance, axis=1)

#Outlier Detection
def remove_outlier(df,columns):
    df2 = df.copy()
    for col in columns:
        Q1 = df2[col].quantile(0.25)
        Q3 = df2[col].quantile(0.75)
        IQR = Q3 - Q1
        low = Q1 - 1.5 * IQR
        high = Q3 + 1.5 * IQR
        df2 = df2[(df2[col] >=low ) & (df2[col] <= high )]
    return df2

df_no_out = remove_outlier(df, ['distance_km', 'fare_amount'])
print('After IQR outlier removal', df_no_out.shape)
df = df_no_out.copy()

#Detect Outlier
plt.figure(figsize=(6,4))
sns.boxplot(x=df['fare_amount'])
plt.title("Outlier in fare amount")
plt.show()

plt.figure(figsize=(6,4))
sns.boxplot(x=df['distance_km'])
plt.title("Outliers in Distance")
plt.show()

#Correlation check
corr = df[['fare_amount','distance_km']].corr()
print(corr)

sns.heatmap(corr, annot=True)
plt.title("Correlation Heatmap")
plt.show()

#Model Selection 
X = df[['distance_km']]
Y = df['fare_amount']
X = df[['distance_km']]
Y = df['fare_amount']
X_train,X_test,Y_train,Y_test = train_test_split(X,Y,test_size= 0.2,random_state = 18)

lr = LinearRegression()
lr.fit(X_train,Y_train)
y_pred_lr = lr.predict(X_test)

rf = RandomForestRegressor()
rf.fit(X_train,Y_train)
y_pred_rf = rf.predict(X_test)

#Metrics
print("---- Linear Regression ----")
print("R2 Score:", r2_score(Y_test, y_pred_lr))
print("RMSE:", np.sqrt(mean_squared_error(Y_test, y_pred_lr)))

print("----Random Forest Regression ----")
print("R2 Score:", r2_score(Y_test, y_pred_rf))
print("RMSE:", np.sqrt(mean_squared_error(Y_test, y_pred_rf)))